generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  name           String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  role           String          @default("owner")
  isAdmin        Boolean         @default(false)
  auditLogs      AuditLog[]
  salon          Salon?
  salonMembers   SalonMember[]
  subscription   Subscription?
  supportTickets SupportTicket[]
}

model Salon {
  id             String              @id @default(cuid())
  name           String
  description    String?
  phone          String?
  address        String?
  city           String?
  postalCode     String?
  email          String?
  logo           String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  userId         String              @unique
  invoiceNotes   String?
  invoiceTerms   String?
  legalForm      String?
  legalName      String?
  siret          String?
  tvaNumber      String?
  appointments   Appointment[]
  auditLogs      AuditLog[]
  clients        Client[]
  categories     InventoryCategory[]
  inventory      InventoryItem[]
  invoices       Invoice[]
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  members        SalonMember[]
  services       Service[]
  stockSales     StockSale[]         @relation("SalonStockSales")
  supportTickets SupportTicket[]
}

model Client {
  id           String        @id @default(cuid())
  firstName    String
  lastName     String
  email        String?
  phone        String?
  address      String?
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  salonId      String
  deletedAt    DateTime?
  privateNotes String?
  animals      Animal[]
  appointments Appointment[]
  salon        Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  stockSales   StockSale[]   @relation("ClientStockSales")

  @@index([salonId])
  @@index([deletedAt])
}

model Animal {
  id            String        @id @default(cuid())
  name          String
  species       String
  breed         String?
  color         String?
  dateOfBirth   DateTime?
  notes         String?
  photo         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  clientId      String
  allergies     String?
  deletedAt     DateTime?
  groomingNotes String?
  healthNotes   String?
  lastGrooming  DateTime?
  temperament   String?
  weight        Float?
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appointments  Appointment[]

  @@index([clientId])
  @@index([deletedAt])
}

model Service {
  id           String        @id @default(cuid())
  name         String
  description  String?
  price        Float
  duration     Int
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  salonId      String
  isFlexible   Boolean       @default(false)
  maxDuration  Int?
  maxPrice     Float?
  minDuration  Int?
  minPrice     Float?
  appointments Appointment[]
  salon        Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
}

model Appointment {
  id                 String    @id @default(cuid())
  date               DateTime
  startTime          DateTime
  endTime            DateTime
  notes              String?
  status             String    @default("scheduled")
  totalPrice         Float
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  salonId            String
  clientId           String
  animalId           String
  serviceId          String
  cancellationReason String?
  cancelledAt        DateTime?
  deletedAt          DateTime?
  internalNotes      String?
  isLateCancel       Boolean   @default(false)
  animal             Animal    @relation(fields: [animalId], references: [id], onDelete: Cascade)
  client             Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  salon              Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  service            Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  invoices           Invoice[]

  @@index([salonId])
  @@index([clientId])
  @@index([animalId])
  @@index([serviceId])
  @@index([status])
  @@index([deletedAt])
}

model InventoryCategory {
  id          String          @id @default(cuid())
  name        String
  description String?
  color       String?
  icon        String?
  createdAt   DateTime        @default(now()) @db.Timestamp(6)
  updatedAt   DateTime        @updatedAt @db.Timestamp(6)
  salonId     String
  salon       Salon           @relation(fields: [salonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  items       InventoryItem[]

  @@unique([salonId, name])
  @@index([salonId])
}

model InventoryItem {
  id            String             @id @default(cuid())
  name          String
  description   String?
  quantity      Int
  unit          String
  price         Float
  lastRestocked DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  salonId       String
  categoryId    String?
  category      InventoryCategory? @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  salon         Salon              @relation(fields: [salonId], references: [id], onDelete: Cascade)
  stockSales    StockSale[]        @relation("InventoryItemStockSales")

  @@index([salonId])
  @@index([categoryId])
}

model StockSale {
  id              String        @id @default(cuid())
  quantity        Int
  pricePerUnit    Float
  total           Float
  notes           String?
  createdAt       DateTime      @default(now()) @db.Timestamp(6)
  salonId         String
  clientId        String
  inventoryItemId String
  invoiceId       String?
  client          Client        @relation("ClientStockSales", fields: [clientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  inventoryItem   InventoryItem @relation("InventoryItemStockSales", fields: [inventoryItemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  invoice         Invoice?      @relation("InvoiceStockSales", fields: [invoiceId], references: [id], onUpdate: NoAction)
  salon           Salon         @relation("SalonStockSales", fields: [salonId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([salonId])
  @@index([clientId])
  @@index([inventoryItemId])
  @@index([invoiceId])
}

model Subscription {
  id                   String   @id @default(cuid())
  plan                 String   @default("monthly")
  price                Float
  currency             String   @default("EUR")
  status               String   @default("active")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String       @id @default(cuid())
  invoiceNumber String       @unique
  subtotal      Float
  taxRate       Float        @default(20)
  taxAmount     Float
  total         Float
  status        String       @default("draft")
  paidAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  salonId       String
  clientId      String
  appointmentId String?
  deletedAt     DateTime?
  dueDate       DateTime?
  paymentMethod String?
  type          String       @default("appointment")
  items         String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  client        Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  salon         Salon        @relation(fields: [salonId], references: [id], onDelete: Cascade)
  stockSales    StockSale[]  @relation("InvoiceStockSales")

  @@index([salonId])
  @@index([clientId])
  @@index([appointmentId])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entityType String
  entityId   String
  oldValue   String?
  newValue   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  userId     String
  salonId    String
  salon      Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Reminder {
  id            String    @id @default(cuid())
  type          String
  channel       String    @default("email")
  scheduledFor  DateTime
  sentAt        DateTime?
  status        String    @default("pending")
  error         String?
  appointmentId String?
  invoiceId     String?
  createdAt     DateTime  @default(now())

  @@index([scheduledFor, status])
}

model SalonMember {
  id                    String    @id @default(cuid())
  role                  String    @default("staff")
  firstName             String?
  lastName              String?
  phone                 String?
  invitedAt             DateTime  @default(now())
  acceptedAt            DateTime?
  status                String    @default("pending")
  canManageClients      Boolean   @default(true)
  canManageAnimals      Boolean   @default(true)
  canManageAppointments Boolean   @default(true)
  canManageServices     Boolean   @default(true)
  canManageInventory    Boolean   @default(true)
  canViewReports        Boolean   @default(false)
  canManageBilling      Boolean   @default(false)
  canManageSettings     Boolean   @default(false)
  canManageMembers      Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  userId                String?
  salonId               String
  inviteEmail           String?
  inviteToken           String?   @unique
  salon                 Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  user                  User?     @relation(fields: [userId], references: [id])

  @@unique([userId, salonId])
  @@index([salonId])
  @@index([inviteToken])
  @@index([status])
}

model SupportTicket {
  id           String          @id @default(cuid())
  ticketNumber String          @unique
  subject      String
  description  String
  category     String          @default("general")
  priority     String          @default("normal")
  status       String          @default("open")
  browser      String?
  os           String?
  appVersion   String?
  resolvedAt   DateTime?
  closedAt     DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  userId       String
  salonId      String?
  assignedToId String?
  salon        Salon?          @relation(fields: [salonId], references: [id])
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages     TicketMessage[]

  @@index([userId])
  @@index([salonId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

model TicketMessage {
  id           String        @id @default(cuid())
  content      String
  isStaffReply Boolean       @default(false)
  isInternal   Boolean       @default(false)
  attachments  String[]
  createdAt    DateTime      @default(now())
  ticketId     String
  authorId     String
  authorName   String
  ticket       SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([createdAt])
}

model ErrorLog {
  id         String    @id @default(cuid())
  message    String
  stack      String?
  severity   String    @default("error")
  userId     String?
  salonId    String?
  url        String?
  method     String?
  userAgent  String?
  ipAddress  String?
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?
  notes      String?
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([salonId])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
}

model ActivityLog {
  id         String   @id @default(cuid())
  action     String
  resource   String
  userId     String
  resourceId String?
  salonId    String?
  oldValue   String?
  newValue   String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([salonId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

model UserInteraction {
  id            String    @id @default(cuid())
  type          String
  subject       String?
  description   String
  userId        String
  salonId       String?
  status        String    @default("open")
  resolved      Boolean   @default(false)
  resolvedAt    DateTime?
  requiresReply Boolean   @default(false)
  lastReplyAt   DateTime?
  replied       Boolean   @default(false)
  priority      String    @default("normal")
  tags          String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId])
  @@index([salonId])
  @@index([type])
  @@index([status])
  @@index([requiresReply])
  @@index([createdAt])
}

model FeatureUsageLog {
  id          String   @id @default(cuid())
  featureName String
  action      String
  userId      String
  salonId     String
  duration    Int?
  itemCount   Int?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([salonId])
  @@index([featureName])
  @@index([createdAt])
}

model PerformanceMetric {
  id          String   @id @default(cuid())
  metric      String
  value       Float
  endpoint    String?
  userId      String?
  salonId     String?
  isSlowQuery Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([metric])
  @@index([isSlowQuery])
  @@index([createdAt])
}
